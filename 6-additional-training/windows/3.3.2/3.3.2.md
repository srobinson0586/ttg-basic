# Demonstrate the basics of assembly programming in Windows


## Instructions
- Install Visual Studio 2022 (not VS Code)

- Install Windbg

- Complete the TODOs in `exercise.asm`

- Test your project by building it in Visual Studio and then running it from
  the command line.


## Tips for Windows assembly
- Visual Studio 2022 natively supports the MASM assembler, which uses different
  syntax from NASM.
  - The template already contains the syntax for indicating the segment and
    declaring a procedure.

  - To specify a number in hexadecimal format, use a trailing "h" (e.g., "20h"
    instead of "0x20").

  - Specifying a memory location works differently. You must specify the data
    size and use the keyword "PTR", and an immediate offset (if it's used)
    comes before the square brackets. Here are a few sample instructions:

      - nasm: mov rdi, [rsi]
      - masm: mov rdi, QWORD PTR [rsi]

      - nasm: mov eax, [rsp + 0x28]
      - masm: mov eax, DWORD PTR 28h[rsp]


- The Windows assembly calling convention (or ABI) is fairly different from
  the one for Linux (System V ABI). Here's a summary of the major differences:
  - No matter what, every function owns the 4 quadwords (i.e., 32 bytes) of
    space immediately before its return address on the stack (i.e., at higher
    addresses). Arguments passed on the stack are pushed onto the stack before
    this "shadow space" is allocated.

    This space gives each function the option of putting all the arguments
    they were called with on the stack in adjacent locations.

    A common mistake is for a calling function not to allocate this space.
    In this case, the called function (if it uses the shadow space) will
    smash the topmost bytes of the caller's stack frame, which will probably
    cause a segfault sometime down the road.

  - Arguments are passed in `rcx`, `rdx`, `r8`, `r9`, and then on the stack
    (at higher addresses than the shadow space).

  - All return addresses must be stored on the stack at addresses that end
    with an 8 in hexadecimal. This is a stack alignment requirement. It
    actually also applies in Linux, but in my experience no one pays
    enough attention to it in either.